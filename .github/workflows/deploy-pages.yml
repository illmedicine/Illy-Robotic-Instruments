name: Deploy GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Checkout LivePay
        uses: actions/checkout@v4
        with:
          repository: illmedicine/LivePay
          ref: refs/heads/main
          fetch-depth: 1
          path: _livepay

      - name: Ensure LivePay is latest main
        run: |
          set -euo pipefail
          cd _livepay
          git remote -v
          git fetch --depth=1 origin main
          git reset --hard origin/main
          echo "LivePay SHA: $(git rev-parse HEAD)"

      - name: Checkout IllySocial
        uses: actions/checkout@v4
        with:
          repository: illmedicine/illysocialV2
          ref: main
          path: _illysocial

      - name: Ensure IllySocial is latest main
        run: |
          set -euo pipefail
          cd _illysocial
          git remote -v
          git fetch --depth=1 origin main
          git reset --hard origin/main
          echo "IllySocial SHA: $(git rev-parse HEAD)"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            _livepay/package-lock.json
            _illysocial/Frontend/package-lock.json

      - name: Build LivePay for /livepay
        working-directory: _livepay
        run: |
          npm ci
          npx expo export --platform web

      - name: Normalize LivePay routes for GitHub Pages
        run: |
          # GitHub Pages doesn't support extensionless rewrites by default.
          # Convert generated route HTML files (e.g. settings.html) into folders (settings/index.html).
          set -euo pipefail

          # Expo exports some assets with absolute URLs (e.g. /assets/... and /_expo/...).
          # Since we're hosting under /livepay, rewrite these to relative URLs.
          # This keeps asset loading working when the app is served from /livepay/.
          find _livepay/dist -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) -print0 |
            xargs -0 -I {} perl -0777 -pe 's#"/(_expo/)#"$1#g; s#"/(assets/)#"$1#g; s#url\(\"/(assets/)#url("$1#g; s#url\(/(assets/)#url($1#g' -i "{}"

          # Provide a Pages-compatible 404 for the /livepay subtree.
          if [ -f "_livepay/dist/+not-found.html" ]; then
            cp "_livepay/dist/+not-found.html" "_livepay/dist/404.html"
          fi

          # Convert top-level routes.
          for f in _livepay/dist/*.html; do
            b="$(basename "$f")"
            n="${b%.html}"
            if [ "$b" = "index.html" ] || [ "$b" = "404.html" ] || [ "$b" = "+not-found.html" ] || [ "$b" = "_sitemap.html" ]; then
              continue
            fi
            mkdir -p "_livepay/dist/$n"
            mv "$f" "_livepay/dist/$n/index.html"
          done

          # Convert one-level deep routes (e.g. (tabs)/two.html -> (tabs)/two/index.html).
          for f in _livepay/dist/*/*.html; do
            d="$(dirname "$f")"
            b="$(basename "$f")"
            n="${b%.html}"
            if [ "$b" = "index.html" ] || [ "$b" = "404.html" ] || [ "$b" = "+not-found.html" ] || [ "$b" = "_sitemap.html" ]; then
              continue
            fi
            mkdir -p "$d/$n"
            mv "$f" "$d/$n/index.html"
          done

      - name: Copy LivePay into Pages artifact
        run: |
          rm -rf site-next/public/livepay
          mkdir -p site-next/public/livepay
          cp -a _livepay/dist/. site-next/public/livepay/

      - name: Redirect /livepay to LivePay GitHub Pages
        run: |
          cat > site-next/public/livepay/index.html <<'EOF'
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Redirecting…</title>
              <meta http-equiv="refresh" content="0; url=https://illmedicine.github.io/LivePay/" />
              <script>
                (function () {
                  var target = 'https://illmedicine.github.io/LivePay/';
                  window.location.replace(target);
                })();
              </script>
            </head>
            <body>
              <p>
                Redirecting to
                <a href="https://illmedicine.github.io/LivePay/">https://illmedicine.github.io/LivePay/</a>
              </p>
            </body>
          </html>
          EOF

      - name: Build IllySocial for /illysocial
        working-directory: _illysocial/Frontend
        run: |
          npm ci
          npm run build

      - name: Copy IllySocial into Pages artifact
        run: |
          rm -rf site-next/public/illysocial
          mkdir -p site-next/public/illysocial
          cp -a _illysocial/Frontend/dist/. site-next/public/illysocial/

      - name: Redirect /illysocial to IllySocial GitHub Pages
        run: |
          cat > site-next/public/illysocial/index.html <<'EOF'
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Redirecting…</title>
              <meta http-equiv="refresh" content="0; url=https://illmedicine.github.io/illysocialV2/" />
              <script>
                (function () {
                  var target = 'https://illmedicine.github.io/illysocialV2/';
                  window.location.replace(target);
                })();
              </script>
            </head>
            <body>
              <p>
                Redirecting to
                <a href="https://illmedicine.github.io/illysocialV2/">https://illmedicine.github.io/illysocialV2/</a>
              </p>
            </body>
          </html>
          EOF

          # Support deep links like /illysocial/foo on GitHub Pages.
          # GitHub Pages serves ONLY the site-root /404.html for unknown routes, so:
          # 1) we generate a root 404.html that redirects /illysocial/* -> /illysocial/?p=<path>
          # 2) we patch /illysocial/index.html to restore the original path.
          perl -0777 -pe 's#</head>#<script>(function(){var p=new URLSearchParams(window.location.search);var r=p.get("p");if(r){if(r.startsWith("/")){r=r.slice(1);}window.history.replaceState(null,"",window.location.pathname.replace(/\/?$/,"/")+r+window.location.hash);p.delete("p");var q=p.toString();if(q){window.history.replaceState(null,"",window.location.pathname+"?"+q+window.location.hash);}else{window.history.replaceState(null,"",window.location.pathname+window.location.hash);}}})();</script></head>#s' -i site-next/public/illysocial/index.html

          cat > site-next/public/404.html <<'EOF'
          <!doctype html>
          <html lang="en">
            <head>
              <meta charset="UTF-8" />
              <meta name="viewport" content="width=device-width, initial-scale=1.0" />
              <title>Not Found</title>
              <script>
                (function () {
                  var path = window.location.pathname || '/';
                  if (path.startsWith('/illysocial/')) {
                    var rest = path.substring('/illysocial/'.length);
                    var target = 'https://illmedicine.github.io/illysocialV2/' + rest + window.location.search + window.location.hash;
                    window.location.replace(target);
                    return;
                  }
                  if (path.startsWith('/livepay/')) {
                    var rest = path.substring('/livepay/'.length);
                    var target = 'https://illmedicine.github.io/LivePay/' + rest + window.location.search + window.location.hash;
                    window.location.replace(target);
                    return;
                  }
                })();
              </script>
            </head>
            <body>
              <h1>404</h1>
              <p>Not found. Go to <a href="/">home</a>.</p>
            </body>
          </html>
          EOF

      - name: Verify /livepay artifact exists
        run: |
          test -f site-next/public/livepay/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site-next/public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
